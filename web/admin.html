<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AutoFigure - 管理后台</title>
  <style>
    :root {
      --primary: #2c5282;
      --primary-light: #ebf2ff;
      --primary-hover: #1e3a5f;
      --text: #1a202c;
      --text-secondary: #64748b;
      --bg: #ffffff;
      --bg-page: #f8fafc;
      --border: #e2e8f0;
      --danger: #dc3545;
      --success: #10b981;
      --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans SC", sans-serif;
    }
    *, *::before, *::after { box-sizing: border-box; }
    body { margin: 0; font-family: var(--font); color: var(--text); background: var(--bg-page); min-height: 100vh; }

    .topbar {
      background: #1a202c;
      color: #fff;
      padding: 0 24px;
      height: 52px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .topbar-title { font-size: 16px; font-weight: 700; }
    .topbar-right { display: flex; align-items: center; gap: 12px; }
    .topbar a { color: #94a3b8; text-decoration: none; font-size: 13px; }
    .topbar a:hover { color: #fff; }
    .btn-logout { background: none; border: 1px solid #475569; color: #94a3b8; padding: 4px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; }
    .btn-logout:hover { border-color: #94a3b8; color: #fff; }

    .container { max-width: 960px; margin: 0 auto; padding: 24px; }

    /* Login */
    #loginView { display: flex; align-items: center; justify-content: center; min-height: calc(100vh - 52px); }
    .login-card { background: var(--bg); border-radius: 16px; box-shadow: 0 4px 24px rgba(0,0,0,0.08); padding: 40px 36px; width: 100%; max-width: 380px; text-align: center; }
    .login-card h2 { margin: 0 0 8px; font-size: 22px; }
    .login-card p { margin: 0 0 24px; color: var(--text-secondary); font-size: 14px; }
    .login-card input { width: 100%; padding: 12px 16px; border: 1px solid var(--border); border-radius: 10px; font-size: 15px; text-align: center; margin-bottom: 16px; }
    .login-card input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(44,82,130,0.1); }
    .login-error { color: var(--danger); font-size: 13px; min-height: 20px; margin-bottom: 8px; }

    .btn-primary { display: inline-flex; align-items: center; justify-content: center; width: 100%; background: var(--primary); color: #fff; border: none; padding: 12px; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer; transition: background 0.15s; }
    .btn-primary:hover { background: var(--primary-hover); }
    .btn-primary:disabled { opacity: 0.6; cursor: wait; }

    /* Panel */
    #panelView { display: none; }

    .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .stat-card { background: var(--bg); border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
    .stat-value { font-size: 28px; font-weight: 700; color: var(--primary); }
    .stat-label { font-size: 13px; color: var(--text-secondary); margin-top: 4px; }

    .section-card { background: var(--bg); border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin-bottom: 24px; }
    .section-title { font-size: 16px; font-weight: 600; margin: 0 0 16px; }

    .form-row { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end; }
    .form-group { display: flex; flex-direction: column; gap: 4px; }
    .form-group label { font-size: 12px; font-weight: 600; color: var(--text-secondary); }
    .form-group input, .form-group select { padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary); }
    .btn-sm { padding: 8px 20px; background: var(--primary); color: #fff; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; white-space: nowrap; }
    .btn-sm:hover { background: var(--primary-hover); }

    .gen-result { margin-top: 12px; padding: 12px 16px; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; font-family: monospace; font-size: 13px; word-break: break-all; display: none; }

    /* Table */
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { text-align: left; padding: 10px 12px; color: var(--text-secondary); font-weight: 600; border-bottom: 2px solid var(--border); white-space: nowrap; }
    td { padding: 10px 12px; border-bottom: 1px solid var(--border); white-space: nowrap; }
    .code-cell { font-family: monospace; font-weight: 600; letter-spacing: 0.5px; }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
    .badge-active { background: #dcfce7; color: #166534; }
    .badge-revoked { background: #fee2e2; color: #991b1b; }
    .badge-t { background: var(--primary-light); color: var(--primary); }
    .badge-p { background: #fef3c7; color: #92400e; }
    .btn-revoke { background: none; border: 1px solid rgba(220,53,69,0.3); color: var(--danger); padding: 4px 10px; border-radius: 6px; font-size: 12px; cursor: pointer; }
    .btn-revoke:hover { background: #fee2e2; border-color: var(--danger); }
    .empty-row td { text-align: center; color: var(--text-secondary); padding: 32px; }

    @media (max-width: 640px) {
      .container { padding: 16px; }
      .form-row { flex-direction: column; }
      .stats-row { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <span class="topbar-title">AutoFigure 管理后台</span>
    <div class="topbar-right">
      <a href="/">返回首页</a>
      <button class="btn-logout" id="logoutBtn" style="display:none" onclick="logout()">退出</button>
    </div>
  </div>

  <!-- Login View -->
  <div id="loginView">
    <div class="login-card">
      <h2>管理后台</h2>
      <p>请输入管理员密码</p>
      <input id="adminPwd" type="password" placeholder="管理员密码" />
      <div class="login-error" id="loginError"></div>
      <button class="btn-primary" id="loginBtn">登录</button>
    </div>
  </div>

  <!-- Panel View -->
  <div id="panelView">
    <div class="container">
      <!-- Stats -->
      <div class="stats-row">
        <div class="stat-card"><div class="stat-value" id="statTotal">-</div><div class="stat-label">邀请码总数</div></div>
        <div class="stat-card"><div class="stat-value" id="statActive">-</div><div class="stat-label">有效邀请码</div></div>
        <div class="stat-card"><div class="stat-value" id="statToday">-</div><div class="stat-label">今日使用次数</div></div>
        <div class="stat-card"><div class="stat-value" id="statTotalUsed">-</div><div class="stat-label">累计使用次数</div></div>
      </div>

      <!-- Generate -->
      <div class="section-card">
        <h3 class="section-title">生成邀请码</h3>
        <div class="form-row">
          <div class="form-group">
            <label>类型</label>
            <select id="genType"><option value="T">临时 (T-)</option><option value="P">永久 (P-)</option></select>
          </div>
          <div class="form-group">
            <label>每日限额</label>
            <input id="genLimit" type="number" min="1" value="5" style="width:80px" />
          </div>
          <div class="form-group">
            <label>数量</label>
            <input id="genCount" type="number" min="1" max="20" value="1" style="width:80px" />
          </div>
          <div class="form-group">
            <label>过期日期</label>
            <input id="genExpires" type="date" />
          </div>
          <div class="form-group">
            <label>备注</label>
            <input id="genNote" type="text" placeholder="可选" style="width:140px" />
          </div>
          <button class="btn-sm" id="genBtn">生成</button>
        </div>
        <div class="gen-result" id="genResult"></div>
      </div>

      <!-- Codes List -->
      <div class="section-card">
        <h3 class="section-title">邀请码列表</h3>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>邀请码</th>
                <th>类型</th>
                <th>状态</th>
                <th>今日/限额</th>
                <th>累计</th>
                <th>备注</th>
                <th>创建时间</th>
                <th>过期</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="codesBody">
              <tr class="empty-row"><td colspan="9">加载中...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
  (() => {
    let token = sessionStorage.getItem("admin_token") || "";
    const $ = (id) => document.getElementById(id);

    // Auto-login if token exists
    if (token) {
      showPanel();
    }

    // Login
    $("loginBtn").addEventListener("click", doLogin);
    $("adminPwd").addEventListener("keydown", (e) => { if (e.key === "Enter") doLogin(); });

    async function doLogin() {
      const pwd = $("adminPwd").value.trim();
      if (!pwd) return;
      $("loginBtn").disabled = true;
      $("loginError").textContent = "";
      try {
        const res = await fetch("/api/admin/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ password: pwd }),
        });
        const data = await res.json();
        if (!res.ok) { $("loginError").textContent = data.error || "登录失败"; return; }
        token = data.token;
        sessionStorage.setItem("admin_token", token);
        showPanel();
      } catch (e) {
        $("loginError").textContent = "网络错误";
      } finally {
        $("loginBtn").disabled = false;
      }
    }

    function showPanel() {
      $("loginView").style.display = "none";
      $("panelView").style.display = "block";
      $("logoutBtn").style.display = "inline-block";
      loadStats();
      loadCodes();
    }

    window.logout = function () {
      token = "";
      sessionStorage.removeItem("admin_token");
      $("loginView").style.display = "flex";
      $("panelView").style.display = "none";
      $("logoutBtn").style.display = "none";
    };

    function authHeaders() {
      return { "Content-Type": "application/json", "Authorization": "Bearer " + token };
    }

    async function loadStats() {
      try {
        const res = await fetch("/api/admin/stats", { headers: authHeaders() });
        if (res.status === 401) { window.logout(); return; }
        const d = await res.json();
        $("statTotal").textContent = d.total_codes;
        $("statActive").textContent = d.active_codes;
        $("statToday").textContent = d.used_today;
        $("statTotalUsed").textContent = d.total_used;
      } catch (e) {}
    }

    async function loadCodes() {
      try {
        const res = await fetch("/api/admin/codes", { headers: authHeaders() });
        if (res.status === 401) { window.logout(); return; }
        const codes = await res.json();
        renderCodes(codes);
      } catch (e) {}
    }

    function renderCodes(codes) {
      const tbody = $("codesBody");
      if (!codes.length) {
        tbody.innerHTML = '<tr class="empty-row"><td colspan="9">暂无邀请码</td></tr>';
        return;
      }
      tbody.innerHTML = codes.map((c) => {
        const typeBadge = c.code_type === "P" ? '<span class="badge badge-p">永久</span>' : '<span class="badge badge-t">临时</span>';
        const statusBadge = c.is_active ? '<span class="badge badge-active">有效</span>' : '<span class="badge badge-revoked">已禁用</span>';
        const created = c.created_at ? c.created_at.slice(0, 16).replace("T", " ") : "-";
        const expires = c.expires_at || "-";
        const revokeBtn = c.is_active ? `<button class="btn-revoke" onclick="revokeCode('${c.code}')">禁用</button>` : "-";
        return `<tr>
          <td class="code-cell">${c.code}</td>
          <td>${typeBadge}</td>
          <td>${statusBadge}</td>
          <td>${c.used_today}/${c.daily_limit}</td>
          <td>${c.total_used}</td>
          <td>${c.note || "-"}</td>
          <td>${created}</td>
          <td>${expires}</td>
          <td>${revokeBtn}</td>
        </tr>`;
      }).join("");
    }

    window.revokeCode = async function (code) {
      if (!confirm(`确定禁用邀请码 ${code}？`)) return;
      try {
        await fetch("/api/admin/revoke", { method: "POST", headers: authHeaders(), body: JSON.stringify({ code }) });
        loadCodes();
        loadStats();
      } catch (e) {}
    };

    // Generate
    $("genBtn").addEventListener("click", async () => {
      const body = {
        code_type: $("genType").value,
        daily_limit: parseInt($("genLimit").value, 10) || 5,
        count: parseInt($("genCount").value, 10) || 1,
        note: $("genNote").value.trim(),
        expires_at: $("genExpires").value || null,
      };
      $("genBtn").disabled = true;
      try {
        const res = await fetch("/api/admin/generate", { method: "POST", headers: authHeaders(), body: JSON.stringify(body) });
        if (res.status === 401) { window.logout(); return; }
        const data = await res.json();
        const el = $("genResult");
        el.style.display = "";
        el.textContent = data.codes.join("\n");
        loadCodes();
        loadStats();
      } catch (e) {}
      $("genBtn").disabled = false;
    });
  })();
  </script>
</body>
</html>
